<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="./css/chats.css">
    <link rel="icon" type="image/x-icon" href="./images/favicon/goodtalk.ico">
</head>
<body>

    <header>
        <h1 id="welcome" onclick="leave()">

        </h1>

        <hr>
    </header>

    <main id="chat"></main>
    
    <div id="foot">
        <input type="text" placeholder="Message" id="message"><label for="load"><img src="./images/add-image.png" id="image"></label><input type="file" onchange="previewFile()" id="load"/><input type="button" value="Send" onclick="send()" id="send">
    </div>

    <script>
        document.getElementById("welcome").innerText = `${localStorage.getItem("room")}`

        const socket = new WebSocket(
            `wss://${window.location.host}/chat?username=${localStorage.getItem("username")}&room=${localStorage.getItem("room")}`
        )

        socket.onmessage = (message) => {
            let data = JSON.parse(message.data);
            console.log(data);
            let e = document.createElement("div");
            if (data.image != "") {
                e.innerHTML = `<h2>${data.username}:</h2><p>${data.message}</p><img src="${data.image}"/>`;
            } else {
                e.innerHTML = `<h2>${data.username}:</h2><p>${data.message}</p>`;
            }
            if (data.type == "new-user") {
                e.classList.add("new")
            } else if (data.type == "left-user") {
                e.classList.add("gone")
            } else {
                e.classList.add("message")
            }
            e.classList.add("chat")
            document.getElementById("chat").append(e);
            window.scroll(0, document.body.scrollHeight);
        }

        function send() {
            console.log(document.getElementById("image").src);
            console.log(`https://${window.location.host}/images/add-image.png`)
            if (document.getElementById("image").src == `https://${window.location.host}/images/add-image.png`) {
                socket.send(JSON.stringify({
                    message: document.getElementById("message").value,
                    image: ""
                }))
            } else {
                socket.send(JSON.stringify({
                    message: document.getElementById("message").value,
                    image: document.getElementById("image").src
                }))
            }
            document.getElementById("message").value = "";
            document.getElementById("image").src = "./images/add-image.png";
            preview.classList.add("no_image");
        }

        function previewFile() {
            const preview = document.getElementById("image");
            const file = document.querySelector("input[type=file]").files[0];
            const reader = new FileReader();
          
            reader.addEventListener(
              "load",
              () => {
                // convert image file to base64 string
                preview.src = reader.result;
              },
              false,
            );
          
            if (file) {
              reader.readAsDataURL(file);
            }

            preview.classList.remove("no_image");
        }

        function leave() {
            socket.close()
            window.location.href = './rooms.html';
        }
    </script>
</body>
</html>